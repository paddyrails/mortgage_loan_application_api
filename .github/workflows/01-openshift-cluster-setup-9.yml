name: OpenShift Setup - AWS ROSA Cluster (Run Only Once)

on:
  workflow_dispatch:
    inputs:
      setup_type:
        description: "Select setup to run"
        required: true
        type: choice
        options:
          - all (Complete Setup)
          - verify-prerequisites-only
          - create-vpc-only
          - create-rosa-cluster-only
          - configure-iam-only
      cluster_name:
        description: "ROSA Cluster Name"
        required: true
        default: "loan-app-cluster"
      environment:
        description: "Environment"
        required: true
        type: choice
        options:
          - dev
          - qa
          - preprod
          - prod

env:
  AWS_REGION: us-east-1
  CLUSTER_NAME: ${{ github.event.inputs.cluster_name }}-${{ github.event.inputs.environment }}
  ROSA_VERSION: "4.18.30"
  COMPUTE_NODES: 2
  COMPUTE_MACHINE_TYPE: m5.xlarge

jobs:
  rosa-setup:
    name: ROSA Setup - ${{ github.event.inputs.setup_type }}
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------
      # Step 1: Checkout code
      # -----------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------
      # Step 2: Configure AWS Credentials
      # -----------------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # -----------------------------------------
      # Step 3: Install ROSA CLI and OpenShift CLI
      # -----------------------------------------
      - name: Install ROSA and OpenShift CLI
        run: |
          echo "=========================================="
          echo "Installing ROSA CLI..."
          echo "=========================================="

          # Install ROSA CLI
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/rosa/latest/rosa-linux.tar.gz
          tar -xzf rosa-linux.tar.gz
          sudo mv rosa /usr/local/bin/
          rosa version

          echo ""
          echo "Installing OpenShift CLI (oc)..."

          # Install OpenShift CLI
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xzf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/
          oc version --client

          echo ""
          echo "✅ CLI tools installed successfully!"

      # -----------------------------------------
      # Step 4: Login to ROSA
      # -----------------------------------------
      - name: Login to ROSA
        run: |
          echo "=========================================="
          echo "Logging in to ROSA..."
          echo "=========================================="

          rosa login --token=${{ secrets.ROSA_TOKEN }}

          echo "✅ ROSA login successful!"

      # -----------------------------------------
      # Step 5: Verify Prerequisites
      # -----------------------------------------
      - name: Verify Prerequisites
        if: ${{ github.event.inputs.setup_type == 'all (Complete Setup)' || github.event.inputs.setup_type == 'verify-prerequisites-only' }}
        run: |
          echo "=========================================="
          echo "Verifying AWS Prerequisites..."
          echo "=========================================="

          # Verify AWS credentials
          echo "Checking AWS identity..."
          aws sts get-caller-identity

          echo ""
          echo "Verifying ROSA prerequisites..."
          rosa verify quota --region=${{ env.AWS_REGION }}

          echo ""
          echo "Verifying permissions..."
          rosa verify permissions

          echo ""
          echo "✅ All prerequisites verified!"

      # -----------------------------------------
      # Step 6: Create VPC (if needed)
      # -----------------------------------------
      - name: Create VPC for ROSA
        if: ${{ github.event.inputs.setup_type == 'all (Complete Setup)' || github.event.inputs.setup_type == 'create-vpc-only' }}
        run: |
          echo "=========================================="
          echo "Creating VPC for ROSA Cluster..."
          echo "=========================================="

          VPC_NAME="${{ env.CLUSTER_NAME }}-vpc"

          # Check if VPC already exists
          EXISTING_VPC=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Name,Values=$VPC_NAME" \
            --query 'Vpcs[0].VpcId' \
            --output text 2>/dev/null || echo "None")

          if [ "$EXISTING_VPC" != "None" ] && [ -n "$EXISTING_VPC" ]; then
            echo "✅ VPC '$VPC_NAME' already exists: $EXISTING_VPC"
            echo "VPC_ID=$EXISTING_VPC" >> $GITHUB_ENV
          else
            echo "Creating new VPC..."
            
            # Create VPC
            VPC_ID=$(aws ec2 create-vpc \
              --cidr-block 10.0.0.0/16 \
              --tag-specifications "ResourceType=vpc,Tags=[{Key=Name,Value=$VPC_NAME}]" \
              --query 'Vpc.VpcId' \
              --output text)
            
            echo "VPC created: $VPC_ID"
            
            # Enable DNS hostnames
            aws ec2 modify-vpc-attribute \
              --vpc-id $VPC_ID \
              --enable-dns-hostnames
            
            # Create Internet Gateway
            IGW_ID=$(aws ec2 create-internet-gateway \
              --tag-specifications "ResourceType=internet-gateway,Tags=[{Key=Name,Value=$VPC_NAME-igw}]" \
              --query 'InternetGateway.InternetGatewayId' \
              --output text)
            
            aws ec2 attach-internet-gateway \
              --vpc-id $VPC_ID \
              --internet-gateway-id $IGW_ID
            
            # Create public subnets in different AZs
            SUBNET1_ID=$(aws ec2 create-subnet \
              --vpc-id $VPC_ID \
              --cidr-block 10.0.1.0/24 \
              --availability-zone ${{ env.AWS_REGION }}a \
              --tag-specifications "ResourceType=subnet,Tags=[{Key=Name,Value=$VPC_NAME-public-1}]" \
              --query 'Subnet.SubnetId' \
              --output text)
            
            SUBNET2_ID=$(aws ec2 create-subnet \
              --vpc-id $VPC_ID \
              --cidr-block 10.0.2.0/24 \
              --availability-zone ${{ env.AWS_REGION }}b \
              --tag-specifications "ResourceType=subnet,Tags=[{Key=Name,Value=$VPC_NAME-public-2}]" \
              --query 'Subnet.SubnetId' \
              --output text)
            
            SUBNET3_ID=$(aws ec2 create-subnet \
              --vpc-id $VPC_ID \
              --cidr-block 10.0.3.0/24 \
              --availability-zone ${{ env.AWS_REGION }}c \
              --tag-specifications "ResourceType=subnet,Tags=[{Key=Name,Value=$VPC_NAME-public-3}]" \
              --query 'Subnet.SubnetId' \
              --output text)
            
            # Create route table and associate with subnets
            RTB_ID=$(aws ec2 create-route-table \
              --vpc-id $VPC_ID \
              --tag-specifications "ResourceType=route-table,Tags=[{Key=Name,Value=$VPC_NAME-rtb}]" \
              --query 'RouteTable.RouteTableId' \
              --output text)
            
            aws ec2 create-route \
              --route-table-id $RTB_ID \
              --destination-cidr-block 0.0.0.0/0 \
              --gateway-id $IGW_ID
            
            aws ec2 associate-route-table --subnet-id $SUBNET1_ID --route-table-id $RTB_ID
            aws ec2 associate-route-table --subnet-id $SUBNET2_ID --route-table-id $RTB_ID
            aws ec2 associate-route-table --subnet-id $SUBNET3_ID --route-table-id $RTB_ID
            
            # Enable auto-assign public IP
            aws ec2 modify-subnet-attribute --subnet-id $SUBNET1_ID --map-public-ip-on-launch
            aws ec2 modify-subnet-attribute --subnet-id $SUBNET2_ID --map-public-ip-on-launch
            aws ec2 modify-subnet-attribute --subnet-id $SUBNET3_ID --map-public-ip-on-launch
            
            echo "VPC_ID=$VPC_ID" >> $GITHUB_ENV
            echo "SUBNET_IDS=$SUBNET1_ID,$SUBNET2_ID,$SUBNET3_ID" >> $GITHUB_ENV
            
            echo "✅ VPC created successfully!"

            aws iam create-service-linked-role --aws-service-name "elasticloadbalancing.amazonaws.com"
            echo "✅ Service-linked role for elasticloadbalancing.amazonaws.com created successfully!"
          fi

      # -----------------------------------------
      # Step 7: Configure IAM Roles for ROSA
      # -----------------------------------------
      - name: Configure IAM Roles
        if: ${{ github.event.inputs.setup_type == 'all (Complete Setup)' || github.event.inputs.setup_type == 'configure-iam-only' }}
        run: |
          echo "=========================================="
          echo "Creating IAM Roles for ROSA..."
          echo "=========================================="

          # Create account-wide IAM roles (if not exists)
          rosa create account-roles --mode auto --yes || echo "⚠️ Account roles may already exist"

          echo ""
          echo "✅ IAM roles configured!"

      # -----------------------------------------
      # Step 8: Create ROSA Cluster
      # -----------------------------------------
      - name: Create ROSA Cluster
        if: ${{ github.event.inputs.setup_type == 'all (Complete Setup)' || github.event.inputs.setup_type == 'create-rosa-cluster-only' }}
        run: |
          echo "=========================================="
          echo "Creating ROSA Cluster..."
          echo "=========================================="

          # Check if cluster exists
          if rosa describe cluster --cluster=${{ env.CLUSTER_NAME }} &>/dev/null; then
            echo "✅ Cluster '${{ env.CLUSTER_NAME }}' already exists"
            rosa describe cluster --cluster=${{ env.CLUSTER_NAME }}
          else
            echo "Creating new ROSA cluster '${{ env.CLUSTER_NAME }}'..."
            echo "This will take approximately 30-45 minutes..."
            
            # Get subnet IDs if not set
            if [ -z "$SUBNET_IDS" ]; then
              VPC_NAME="${{ env.CLUSTER_NAME }}-vpc"
              SUBNET_IDS=$(aws ec2 describe-subnets \
                --filters "Name=tag:Name,Values=$VPC_NAME-public-*" \
                --query 'Subnets[*].SubnetId' \
                --output text | tr '\t' ',')
            fi
            
            # Create ROSA cluster with STS
            rosa create cluster \
              --cluster-name=${{ env.CLUSTER_NAME }} \
              --region=${{ env.AWS_REGION }} \
              --version=4.18.30 \
              --replicas=${{ env.COMPUTE_NODES }} \
              --compute-machine-type=${{ env.COMPUTE_MACHINE_TYPE }} \
              --machine-cidr=10.0.0.0/16 \
              --service-cidr=172.30.0.0/16 \
              --pod-cidr=10.128.0.0/14 \
              --host-prefix=23 \
              --subnet-ids=${{ env.SUBNET_IDS }} \
              --multi-az=false \
              --sts \
              --mode=auto \
              --yes
            
            echo ""
            echo "⏳ Cluster creation initiated. Waiting for cluster to be ready..."
            
            # Create operator roles
            rosa create operator-roles --cluster=${{ env.CLUSTER_NAME }} --mode auto --yes
            
            # Create OIDC provider
            rosa create oidc-provider --cluster=${{ env.CLUSTER_NAME }} --mode auto --yes
            
            # Wait for cluster to be ready (with timeout)
            echo "Waiting for cluster installation (this may take 30-45 minutes)..."
            rosa logs install --cluster=${{ env.CLUSTER_NAME }} --watch || true
            
            echo "✅ Cluster creation completed!"
          fi

      # -----------------------------------------
      # Step 9: Create Cluster Admin User
      # -----------------------------------------
      - name: Create Cluster Admin
        if: ${{ github.event.inputs.setup_type == 'all (Complete Setup)' || github.event.inputs.setup_type == 'create-rosa-cluster-only' }}
        run: |
          echo "=========================================="
          echo "Creating Cluster Admin User..."
          echo "=========================================="

          # Wait for cluster to be ready
          CLUSTER_STATE=$(rosa describe cluster --cluster=${{ env.CLUSTER_NAME }} --output json | jq -r '.state')

          if [ "$CLUSTER_STATE" == "ready" ]; then
            # Create cluster admin (save credentials securely)
            rosa create admin --cluster=${{ env.CLUSTER_NAME }} 2>&1 | tee admin-output.txt
            
            echo ""
            echo "⚠️ IMPORTANT: Save the admin credentials from the output above!"
            echo "You will need these to login to the cluster."
          else
            echo "⚠️ Cluster is not ready yet. State: $CLUSTER_STATE"
            echo "Run this workflow again after cluster is ready to create admin."
          fi

      # -----------------------------------------
      # Step 10: Setup Summary
      # -----------------------------------------
      - name: Setup Summary
        run: |
          echo ""
          echo "=========================================="
          echo "✅ OpenShift ROSA Setup Complete!"
          echo "=========================================="
          echo ""
          echo "Cluster Name: ${{ env.CLUSTER_NAME }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Setup Type: ${{ github.event.inputs.setup_type }}"
          echo ""
          echo "----------------------------------------"
          echo "Cluster Status:"
          echo "----------------------------------------"
          rosa describe cluster --cluster=${{ env.CLUSTER_NAME }} 2>/dev/null || echo "Cluster not found or still creating"
          echo ""
          echo "----------------------------------------"
          echo "Next Steps:"
          echo "----------------------------------------"
          echo "1. Wait for cluster to be 'ready' (check: rosa describe cluster --cluster=${{ env.CLUSTER_NAME }})"
          echo "2. Run '02-openshift-namespace-setup' workflow to create namespaces"
          echo "3. Run '04-build-dotnet-app' workflow to build the application"
          echo "4. Run '05-deploy-dotnet-app' workflow to deploy"
          echo ""
          echo "----------------------------------------"
          echo "Required Secrets for GitHub Actions:"
          echo "----------------------------------------"
          echo "- AWS_ACCESS_KEY_ID: Your AWS access key"
          echo "- AWS_SECRET_ACCESS_KEY: Your AWS secret key"
          echo "- ROSA_TOKEN: Get from https://console.redhat.com/openshift/token"
          echo ""
